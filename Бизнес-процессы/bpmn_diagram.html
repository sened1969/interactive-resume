<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BPMN Диаграмма: Обработка пренатального НИПТ-теста Panorama</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 10px;
        }
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }
        .diagram-container {
            width: 100%;
            overflow-x: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 20px;
            background-color: #fafafa;
            margin-bottom: 20px;
        }
        .diagram-container img {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 0 auto;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .error {
            color: #d32f2f;
            padding: 20px;
            background-color: #ffebee;
            border-radius: 4px;
            margin: 20px 0;
        }
        .info {
            background-color: #e3f2fd;
            padding: 15px;
            border-radius: 4px;
            margin-top: 20px;
            font-size: 14px;
            color: #1976d2;
        }
        .code-section {
            margin-top: 30px;
            padding: 15px;
            background-color: #f5f5f5;
            border-radius: 4px;
            border-left: 4px solid #2196F3;
        }
        .code-section h3 {
            margin-top: 0;
            color: #333;
        }
        pre {
            background-color: #263238;
            color: #aed581;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>BPMN Диаграмма</h1>
        <p class="subtitle">Обработка пренатального НИПТ-теста Panorama</p>
        
        <div class="diagram-container">
            <div id="loading" class="loading">
                Загрузка диаграммы...
            </div>
            <div id="error" class="error" style="display: none;"></div>
            <div id="diagram"></div>
        </div>

        <div class="info">
            <strong>Информация:</strong> Диаграмма отображается с использованием PlantUML Server API. 
            Для работы требуется подключение к интернету.
        </div>

        <div class="code-section">
            <h3>Исходный код PlantUML:</h3>
            <pre id="plantuml-code"></pre>
        </div>
    </div>

    <!-- Подключаем библиотеку pako для DEFLATE сжатия -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <!-- Альтернативная библиотека для кодирования PlantUML -->
    <script src="https://cdn.jsdelivr.net/npm/plantuml-encoder@1.4.0/dist/plantuml-encoder.min.js"></script>
    
    <script>
        // PlantUML код из файла (исправленный синтаксис Activity Diagram с правильным распределением по дорожкам)
        const plantumlCode = `@startuml
|Клиент|
start
:Получение заявки на НИПТ Panorama;
:Подтверждение заявки и оплата;
if (Оплата получена?) then (да)
  :Согласие на обработку персональных данных;
  :Забор венозной крови (5-10 мл);
  :Упаковка и отправка образца в Геномед;
|Лаборатория|
  :Прием образца;
  if (Образец валиден?) then (да)
    :Регистрация в ЛИМС;
    :Экстракция ДНК;
    :Подготовка библиотеки;
    :Секвенирование (NGS панель);
    
    group Анализ данных
      :Биоинформатический анализ;
      :Детекция анеуплоидий (трисомии 13,18,21,X,Y);
    end group
    
    :Предварительный отчет;
|Генетик|
    :Клиническая интерпретация результатов;
    note right
      Проверка:
      * Трисомия 21 (Даун)
      * Трисомия 18 (Эдвардс)  
      * Трисомия 13 (Патау)
      * Анеуплоидии X,Y
    end note
    
    if (Результаты критичны?) then (да)
      :Экстренное консультирование;
    else (нет)
    endif
    
    :Формирование финального отчета;
    :Отправка результатов клиенту (портал/почта);
    :Архивация в ЛИМС;
    stop
  else (нет)
|Лаборатория|
    :Уведомление клиента о браке;
    :Запрос повторного образца;
|Клиент|
    stop
  endif
else (нет)
|Клиент|
  :Отправка напоминания об оплате;
  stop
endif
@enduml`;

        // Отображаем код
        document.getElementById('plantuml-code').textContent = plantumlCode;

        // Функция для правильного кодирования PlantUML
        // PlantUML использует DEFLATE сжатие + base64 + замена символов
        function encodePlantUML(text) {
            try {
                if (typeof pako === 'undefined') {
                    throw new Error('pako не загружена');
                }
                
                // Шаг 1: DEFLATE сжатие (возвращает Uint8Array)
                const compressed = pako.deflate(text, { level: 9 });
                
                // Шаг 2: Преобразование Uint8Array в бинарную строку
                let binaryString = '';
                for (let i = 0; i < compressed.length; i++) {
                    binaryString += String.fromCharCode(compressed[i]);
                }
                
                // Шаг 3: Base64 кодирование
                let base64 = btoa(binaryString);
                
                // Шаг 4: Замена символов согласно алгоритму PlantUML
                // 0-9 -> A-J, + -> K, / -> L
                const charMap = {
                    '0': 'A', '1': 'B', '2': 'C', '3': 'D', '4': 'E',
                    '5': 'F', '6': 'G', '7': 'H', '8': 'I', '9': 'J',
                    '+': 'K', '/': 'L'
                };
                
                let encoded = '';
                for (let i = 0; i < base64.length; i++) {
                    const char = base64[i];
                    encoded += charMap[char] || char;
                }
                
                console.log('Кодирование успешно, длина:', encoded.length);
                console.log('Первые 100 символов закодированной строки:', encoded.substring(0, 100));
                return encoded;
            } catch (error) {
                console.error('Ошибка кодирования:', error);
                throw error;
            }
        }

        // Альтернативный метод через POST запрос
        async function loadDiagramViaPOST() {
            const loadingDiv = document.getElementById('loading');
            const errorDiv = document.getElementById('error');
            const diagramDiv = document.getElementById('diagram');

            try {
                // Пробуем разные серверы PlantUML
                const servers = [
                    'https://www.plantuml.com/plantuml',
                    'http://www.plantuml.com/plantuml'
                ];
                
                for (let server of servers) {
                    try {
                        const response = await fetch(`${server}/svg`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'text/plain; charset=utf-8'
                            },
                            body: plantumlCode
                        });

                        if (response.ok) {
                            const svgText = await response.text();
                            console.log('Ответ сервера (первые 200 символов):', svgText.substring(0, 200));
                            // Проверяем, что это действительно SVG
                            if (svgText.includes('<svg') || svgText.includes('<?xml')) {
                                loadingDiv.style.display = 'none';
                                diagramDiv.innerHTML = svgText;
                                return;
                            } else if (svgText.includes('error') || svgText.includes('Error')) {
                                console.error('Сервер вернул ошибку:', svgText);
                                throw new Error('Сервер вернул ошибку: ' + svgText.substring(0, 100));
                            } else {
                                console.warn('Неожиданный формат ответа:', svgText.substring(0, 200));
                                throw new Error('Получен неверный формат ответа: ' + svgText.substring(0, 100));
                            }
                        } else {
                            const errorText = await response.text();
                            console.error('Ошибка HTTP:', response.status, errorText);
                            throw new Error(`HTTP ${response.status}: ${errorText.substring(0, 100)}`);
                        }
                    } catch (e) {
                        console.log(`Сервер ${server} не ответил:`, e);
                        continue;
                    }
                }
                throw new Error('Все серверы недоступны');
            } catch (error) {
                console.error('Ошибка POST запроса:', error);
                throw error;
            }
        }

        // Функция для кодирования с использованием библиотеки plantuml-encoder
        function encodePlantUMLWithLibrary(text) {
            if (typeof plantumlEncoder !== 'undefined') {
                try {
                    const encoded = plantumlEncoder.encode(text);
                    console.log('Кодирование через библиотеку успешно');
                    return encoded;
                } catch (error) {
                    console.error('Ошибка кодирования через библиотеку:', error);
                }
            }
            return null;
        }

        // Функция для загрузки диаграммы через GET запрос
        async function loadDiagramViaGET() {
            const loadingDiv = document.getElementById('loading');
            const errorDiv = document.getElementById('error');
            const diagramDiv = document.getElementById('diagram');

            try {
                // Пробуем использовать библиотеку plantuml-encoder
                let encoded = encodePlantUMLWithLibrary(plantumlCode);
                
                // Если библиотека не доступна, используем наш метод
                if (!encoded) {
                    if (typeof pako === 'undefined') {
                        throw new Error('Библиотеки pako и plantuml-encoder не загружены');
                    }
                    encoded = encodePlantUML(plantumlCode);
                }
                
                console.log('Закодированная строка (первые 50 символов):', encoded.substring(0, 50));
                
                // Пробуем разные форматы URL
                const urls = [
                    `https://www.plantuml.com/plantuml/svg/${encoded}`,
                    `http://www.plantuml.com/plantuml/svg/${encoded}`,
                    `https://www.plantuml.com/plantuml/png/${encoded}`
                ];
                
                let imgLoaded = false;
                
                for (let url of urls) {
                    try {
                        const img = document.createElement('img');
                        img.alt = 'BPMN Диаграмма';
                        img.style.maxWidth = '100%';
                        img.style.height = 'auto';
                        
                        await new Promise((resolve, reject) => {
                            img.onload = () => {
                                loadingDiv.style.display = 'none';
                                diagramDiv.appendChild(img);
                                imgLoaded = true;
                                resolve();
                            };
                            img.onerror = () => {
                                console.log('Не удалось загрузить изображение с URL:', url);
                                reject(new Error('Ошибка загрузки изображения'));
                            };
                            img.src = url;
                            
                            // Таймаут для загрузки
                            setTimeout(() => {
                                if (!imgLoaded) {
                                    reject(new Error('Таймаут загрузки'));
                                }
                            }, 10000);
                        });
                        break;
                    } catch (e) {
                        console.log('Ошибка с URL:', url, e);
                        continue;
                    }
                }
                
                if (!imgLoaded) {
                    throw new Error('Не удалось загрузить изображение ни с одного URL');
                }
            } catch (error) {
                console.error('Ошибка GET запроса:', error);
                throw error;
            }
        }

        // Метод через альтернативный сервер (plantuml.com через прокси)
        async function loadDiagramViaProxy() {
            const loadingDiv = document.getElementById('loading');
            const errorDiv = document.getElementById('error');
            const diagramDiv = document.getElementById('diagram');

            try {
                // Используем публичный прокси для PlantUML
                const encoded = encodeURIComponent(plantumlCode);
                const proxyUrl = `https://www.plantuml.com/plantuml/svg/${encoded}`;
                
                // Пробуем загрузить через iframe или напрямую
                const response = await fetch(`https://cors-anywhere.herokuapp.com/${proxyUrl}`, {
                    method: 'GET',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                }).catch(() => {
                    // Если прокси не работает, пробуем напрямую
                    return fetch(proxyUrl);
                });

                if (response.ok) {
                    const svgText = await response.text();
                    if (svgText.includes('<svg') || svgText.includes('<?xml')) {
                        loadingDiv.style.display = 'none';
                        diagramDiv.innerHTML = svgText;
                        return true;
                    }
                }
                return false;
            } catch (error) {
                console.log('Прокси метод не сработал:', error);
                return false;
            }
        }

        // Основная функция загрузки диаграммы
        async function loadDiagram() {
            const loadingDiv = document.getElementById('loading');
            const errorDiv = document.getElementById('error');
            const diagramDiv = document.getElementById('diagram');

            console.log('Начинаем загрузку диаграммы...');
            console.log('Длина PlantUML кода:', plantumlCode.length);

            // Метод 1: POST запрос (самый надежный)
            try {
                console.log('Пробуем POST метод...');
                await loadDiagramViaPOST();
                console.log('POST метод успешен!');
                return;
            } catch (postError) {
                console.log('POST метод не сработал:', postError);
            }

            // Метод 2: GET запрос с кодированием
            try {
                if (typeof pako === 'undefined') {
                    throw new Error('Библиотека pako не загружена. Пожалуйста, обновите страницу.');
                }
                console.log('Пробуем GET метод...');
                await loadDiagramViaGET();
                console.log('GET метод успешен!');
                return;
            } catch (getError) {
                console.log('GET метод не сработал:', getError);
            }

            // Метод 3: Через прокси (если доступен)
            try {
                console.log('Пробуем прокси метод...');
                const success = await loadDiagramViaProxy();
                if (success) {
                    console.log('Прокси метод успешен!');
                    return;
                }
            } catch (proxyError) {
                console.log('Прокси метод не сработал:', proxyError);
            }

            // Если все методы не сработали, показываем ошибку
            loadingDiv.style.display = 'none';
            errorDiv.style.display = 'block';
            errorDiv.innerHTML = `
                <strong>Ошибка загрузки диаграммы</strong><br><br>
                <strong>Попробованные методы:</strong><br>
                1. POST запрос к PlantUML серверу<br>
                2. GET запрос с кодированием<br>
                3. Через прокси сервер<br><br>
                <strong>Возможные причины:</strong><br>
                1. Нет подключения к интернету<br>
                2. PlantUML сервер недоступен или блокируется<br>
                3. Ошибка в синтаксисе PlantUML кода<br>
                4. Блокировка CORS политикой браузера<br>
                5. BPMN синтаксис может не поддерживаться через веб-интерфейс<br><br>
                <strong>Важно для диагностики:</strong><br>
                • Откройте консоль браузера (нажмите F12, затем вкладка "Console")<br>
                • Проверьте вкладку "Network" для просмотра запросов к серверу<br>
                • Все детали ошибок выводятся в консоль<br><br>
                <strong>Рекомендации:</strong><br>
                • Проверьте подключение к интернету<br>
                • Попробуйте открыть файл в другом браузере<br>
                • Используйте локальный PlantUML сервер для BPMN диаграмм<br>
                • Проверьте, не блокирует ли антивирус или файрвол запросы<br><br>
                <strong>Альтернативные способы использования:</strong><br>
                1. Скопируйте PlantUML код ниже и используйте в:<br>
                   • Онлайн редакторе: <a href="http://www.plantuml.com/plantuml/uml/" target="_blank">plantuml.com</a><br>
                   • Локальном PlantUML: <code>java -jar plantuml.jar diagram.puml</code><br>
                2. Используйте VS Code с расширением PlantUML<br>
                3. Используйте IntelliJ IDEA с плагином PlantUML
            `;
            console.error('Все методы загрузки не сработали');
            console.log('Для диагностики проверьте:');
            console.log('1. Консоль браузера (F12 -> Console)');
            console.log('2. Вкладку Network для просмотра запросов');
            console.log('3. Ответы сервера в логах выше');
        }

        // Тестовая функция для проверки подключения к PlantUML серверу
        async function testPlantUMLConnection() {
            const testCode = '@startuml\nAlice -> Bob: Hello\n@enduml';
            try {
                const response = await fetch('https://www.plantuml.com/plantuml/svg', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain; charset=utf-8'
                    },
                    body: testCode
                });
                console.log('Тест подключения:', response.ok ? 'Успешно' : 'Ошибка ' + response.status);
                return response.ok;
            } catch (error) {
                console.log('Тест подключения не прошел:', error);
                return false;
            }
        }

        // Загружаем диаграмму после загрузки страницы
        window.addEventListener('DOMContentLoaded', async function() {
            console.log('Страница загружена');
            console.log('pako доступна:', typeof pako !== 'undefined');
            
            // Тестируем подключение
            const connectionOk = await testPlantUMLConnection();
            console.log('Подключение к PlantUML серверу:', connectionOk ? 'OK' : 'FAILED');
            
            // Ждем загрузки pako (для GET метода)
            if (typeof pako !== 'undefined') {
                loadDiagram();
            } else {
                // Пробуем загрузить без pako (POST метод)
                setTimeout(function() {
                    loadDiagram();
                }, 500);
            }
        });
    </script>
</body>
</html>
